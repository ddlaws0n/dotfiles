# Main zsh configuration - ultra-minimal setup with antidote

# Suppress cd output during startup
export _SHELL_STARTING=1
export ZDOTDIR="${ZDOTDIR:-$HOME/.config/zsh}"

# Antidote plugin manager setup
zsh_plugins=${ZDOTDIR:-$HOME}/.zsh_plugins
[[ -f ${zsh_plugins}.txt ]] || touch ${zsh_plugins}.txt

source /opt/homebrew/share/antidote/antidote.zsh

# Generate static plugin file when bundle is newer
if [[ ! ${zsh_plugins}.zsh -nt ${zsh_plugins}.txt ]]; then
  echo "Generating antidote plugin cache..."
  antidote bundle <${zsh_plugins}.txt >${zsh_plugins}.zsh
fi

source ${zsh_plugins}.zsh

# Plugin configuration
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=60"
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE="20"
ZSH_AUTOSUGGEST_USE_ASYNC=1

# Completion styles handled in completions.zsh

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt appendhistory sharehistory incappendhistory
setopt hist_ignore_all_dups hist_save_no_dups hist_ignore_space hist_reduce_blanks

# Performance optimizations
setopt no_beep                    # Silence terminal bells
export DISABLE_UNTRACKED_FILES_DIRTY=true  # Faster git status in large repos

# Smart history navigation keybinds
bindkey '^p' history-search-backward    # Ctrl+P for previous matching command
bindkey '^n' history-search-forward     # Ctrl+N for next matching command

# Load configuration files
for config_file in "$ZDOTDIR"/aliases.zsh "$ZDOTDIR"/completions.zsh; do
  [[ -r "$config_file" ]] && source "$config_file"
done

# External integrations
[[ -f ~/.config/op/plugins.sh ]] && source ~/.config/op/plugins.sh

# Ghostty shell integration (enables enhanced terminal features)
if [[ -n $GHOSTTY_RESOURCES_DIR ]]; then
  source "$GHOSTTY_RESOURCES_DIR"/shell-integration/zsh/ghostty-integration
fi

# Initialize starship prompt
eval "$(starship init zsh)"

# Clear startup flag
unset _SHELL_STARTING